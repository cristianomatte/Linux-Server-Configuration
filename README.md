# Linux Server Configuration


## Project Overview
You will take a baseline installation of a Linux server and prepare it to host your web applications. You will secure your server from a number of attack vectors, install and configure a database server, and deploy one of your existing web applications onto it.


## Configuration Steps

### Secure your server

#### Update all currently installed packages.
```bash
sudo apt-get update
sudo apt-get upgrade
sudo apt-get dist-upgrade
```

#### Change the SSH port from 22 to 2200. Make sure to configure the Lightsail firewall to allow it.
- Edit the file `/etc/ssh/sshd_config`, changing the line with `# Port 22` to `Port 2200`.
- Restart the `sshd` service with `sudo service sshd restart`.
- On Lightsail Networking configurations, add port `2200` and remove port `22` from Firewall settings.

#### Configure the Uncomplicated Firewall (UFW) to only allow incoming connections for SSH (port 2200), HTTP (port 80), and NTP (port 123).
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 2200/tcp
sudo ufw allow www
sudo ufw allow ntp
sudo ufw enable
```

### Give `grader` access.
#### Create a new user account named grader.
```bash
sudo adduser grader --disabled-password
```
#### Give grader the permission to sudo.
- Create the file `/etc/sudoers.d/grader` with the following content:
```bash
# User rules for grader
grader ALL=(ALL) NOPASSWD:ALL
```
#### Create an SSH key pair for grader using the ssh-keygen tool.
- Create an RSA key pair on the local machine by using `ssh-keygen`.
- Create the `.ssh` directory and `authorized_keys` file for the `grader` user.
```bash
sudo su grader
mkdir /home/grader/.ssh
touch /home/grader/authorized_keys
```
- Add the content of the `.pub` file generated by `ssh-keygen` to the `authorized_keys` file.
- Change the `.ssh` directory and `authorized_keys` file permissions.
```bash
chmod 700 /home/grader/.ssh
chmod 644 /home/grader/authorized_keys
```

### Prepare to deploy your project.
#### Configure the local timezone to UTC.
```bash
sudo dpkg-reconfigure tzdata
```
- Select: `None of the above` 
- Select: `UTC`

#### Install and configure Apache to serve a Python mod_wsgi application.
```bash
sudo apt-get install apache2
sudo apt-get install libapache2-mod-wsgi-py3
```

#### Install and configure PostgreSQL
```bash
sudo apt-get install postgresql libpq-dev
```

##### Do not allow remote connections
- Check the file `/etc/postgresql/9.5/main/pg_hba.conf`. It must have the following:
```
local   all     postgres    peer
local   all     all         peer
host    all     all         127.0.0.1/32    md5
host    all     all         ::1/128         md5
```

##### Create a new database user named catalog that has limited permissions to your catalog application database.
```
sudo su - postgres
psql
postgres=# CREATE USER catalog WITH PASSWORD 'catalog' CREATEDB;
postgres=# CREATE DATABASE catalog WITH OWNER catalog;
```

#### Install git.
``` bash
sudo apt-get install git
```

### Deploy the Item Catalog project.
#### Clone and setup your Item Catalog project from the Github repository you created earlier in this Nanodegree program.
- Clone the repository and change its directory tree ownership to `grader`.
```bash
sudo mkdir /var/www/catalog
sudo git clone https://github.com/cristianomatte/Item-Catalog.git /var/www/catalog/
sudo chown -R grader:grader /var/www/catalog/
```
- Install `pip` and the required Python dependencies.
```bash
sudo apt-get install python3-pip
sudo pip3 install -r /var/www/catalog/requirements.txt
sudo pip3 install psycopg2
```

#### Set it up in your server so that it functions correctly when visiting your serverâ€™s IP address in a browser. Make sure that your .git directory is not publicly accessible via a browser!
- In file `item_catalog.py` (`/var/www/catalog/`), remove the `app.secret_key` configuration (lines `16-20`).
- Change the line `app.run(host="0.0.0.0", port=8000, debug=True)` in file `item_catalog.py` to `app.run()`.
- Create the `application.wsgi` file at `/var/www/catalog/` with the folowing content:
```python
import sys
import json

sys.path.insert(0, '/var/www/catalog')

from item_catalog import app as application
with open('/var/www/catalog/client_secrets.json', 'r') as file:
    # Read secret key from configuration file
    data = file.read()
    dictionary = json.loads(data)
    application.secret_key = dictionary['app']['secret_key']
```
- To use the PostgreSQL database, change the line `engine = create_engine("sqlite:///item-catalog.db")` in file `sqlite.py` (`/var/www/catalog/repository/`) to `engine = create_engine('postgresql://catalog:catalog@localhost/catalog')`.
- Generate the initial database data by running the script `lots_of_items.py` (`/var/www/catalog/`).
- To enable Google Sign In, add the following to the OAuth client credentials at the [developers console](https://console.developers.google.com):
    - Add `xip.io` to the authorized domains.
    - Add `http://54.91.188.111.xip.io` to the allowed JavaScript origins.
- Create the Virtual Host configuration file (`/etc/apache2/sites-available/catalog.conf`) with the following content:
```xml
<VirtualHost *:80>
    ServerName 54.91.188.111
    ServerAlias 54.91.188.111.xip.io
    ServerAdmin grader@54.91.188.111
    WSGIScriptAlias / /var/www/catalog/application.wsgi
    <Directory /var/www/catalog/>
        Order allow,deny
        Allow from all
    </Directory>
    Alias /static /var/www/catalog/static
    <Directory /var/www/www/static/>
        Order allow,deny
        Allow from all
    </Directory>
    ErrorLog ${APACHE_LOG_DIR}/error.log
    LogLevel warn
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```
-  Enable the Virtual Host file created for the application.
```
sudo a2ensite catalog.conf
```


## References

- [Changing the SSH Port for Your Linux Server](https://www.godaddy.com/help/changing-the-ssh-port-for-your-linux-server-7306)
- [ubuntu - Creating a user without a password](https://unix.stackexchange.com/questions/56765/creating-an-user-without-a-password)
- [How To Secure PostgreSQL on an Ubuntu VPS](https://www.digitalocean.com/community/tutorials/how-to-secure-postgresql-on-an-ubuntu-vps)
- [mod_wsgi (Apache)](http://flask.pocoo.org/docs/1.0/deploying/mod_wsgi/)
- [How To Set Up Apache Virtual Hosts on Ubuntu 16.04](https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-virtual-hosts-on-ubuntu-16-04)
